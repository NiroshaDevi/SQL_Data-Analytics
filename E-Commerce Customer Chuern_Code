
USE ecomm;

-- Disable safe updates for this session (so UPDATE ... without WHERE allowed in dev)
SET SESSION sql_safe_updates = 0;

-- Start a transaction for the major transformation steps
START TRANSACTION;

-- ---------- 1) Imputation: means/rounding ----------

-- WarehouseToHome (integer, round to nearest integer)
SET @WarehouseToHome_AVG = (SELECT AVG(WarehouseToHome) FROM customer_churn WHERE WarehouseToHome IS NOT NULL);
SET @WarehouseToHome_AVG = IFNULL(ROUND(@WarehouseToHome_AVG), 0);

UPDATE customer_churn
SET WarehouseToHome = @WarehouseToHome_AVG
WHERE WarehouseToHome IS NULL;

-- HoursSpentOnApp (original column HourSpendOnApp; will be renamed later)
SET @HoursSpentOnApp_AVG = (SELECT AVG(HourSpendOnApp) FROM customer_churn WHERE HourSpendOnApp IS NOT NULL);
SET @HoursSpentOnApp_AVG = IFNULL(ROUND(@HoursSpentOnApp_AVG), 0);

UPDATE customer_churn
SET HourSpendOnApp = @HoursSpentOnApp_AVG
WHERE HourSpendOnApp IS NULL;

-- OrderAmountHikeFromlastYear (numeric, keep two decimals)
SET @OrderAmountHikeFromlastYear_AVG = (SELECT AVG(OrderAmountHikeFromlastYear) FROM customer_churn WHERE OrderAmountHikeFromlastYear IS NOT NULL);
SET @OrderAmountHikeFromlastYear_AVG = IFNULL(ROUND(@OrderAmountHikeFromlastYear_AVG,2), 0.00);

UPDATE customer_churn
SET OrderAmountHikeFromlastYear = @OrderAmountHikeFromlastYear_AVG
WHERE OrderAmountHikeFromlastYear IS NULL;

-- DaySinceLastOrder (integer)
SET @DaySinceLastOrder_AVG = (SELECT AVG(DaySinceLastOrder) FROM customer_churn WHERE DaySinceLastOrder IS NOT NULL);
SET @DaySinceLastOrder_AVG = IFNULL(ROUND(@DaySinceLastOrder_AVG), 0);

UPDATE customer_churn
SET DaySinceLastOrder = @DaySinceLastOrder_AVG
WHERE DaySinceLastOrder IS NULL;

-- ---------- 2) Imputation: mode for categorical/integer fields ----------

-- Tenure (mode)
SET @TenureMode = (
  SELECT Tenure FROM customer_churn
  WHERE Tenure IS NOT NULL
  GROUP BY Tenure
  ORDER BY COUNT(*) DESC
  LIMIT 1
);
SET @TenureMode = IFNULL(@TenureMode, 0);

UPDATE customer_churn
SET Tenure = @TenureMode
WHERE Tenure IS NULL;

-- CouponUsed (mode)
SET @CouponUsedMode = (
  SELECT CouponUsed FROM customer_churn
  WHERE CouponUsed IS NOT NULL
  GROUP BY CouponUsed
  ORDER BY COUNT(*) DESC
  LIMIT 1
);
SET @CouponUsedMode = IFNULL(@CouponUsedMode, 0);

UPDATE customer_churn
SET CouponUsed = @CouponUsedMode
WHERE CouponUsed IS NULL;

-- OrderCount (mode)
SET @OrderCountMode = (
  SELECT OrderCount FROM customer_churn
  WHERE OrderCount IS NOT NULL
  GROUP BY OrderCount
  ORDER BY COUNT(*) DESC
  LIMIT 1
);
SET @OrderCountMode = IFNULL(@OrderCountMode, 0);

UPDATE customer_churn
SET OrderCount = @OrderCountMode
WHERE OrderCount IS NULL;

-- ---------- 3) Outliers: cap instead of deleting ----------

-- Cap WarehouseToHome at 100 (better than deleting rows)
UPDATE customer_churn
SET WarehouseToHome = 100
WHERE WarehouseToHome > 100;

-- ---------- 4) Inconsistencies / standardization ----------

-- Trim whitespace
UPDATE customer_churn
SET PreferredLoginDevice = TRIM(PreferredLoginDevice)
WHERE PreferredLoginDevice IS NOT NULL;

UPDATE customer_churn
SET PreferedOrderCat = TRIM(PreferedOrderCat)
WHERE PreferedOrderCat IS NOT NULL;

-- Standardize PreferredLoginDevice / PreferedOrderCat values
UPDATE customer_churn
SET PreferredLoginDevice = 'Mobile Phone'
WHERE PreferredLoginDevice IN ('Phone','Mobile');

UPDATE customer_churn
SET PreferedOrderCat = 'Mobile Phone'
WHERE PreferedOrderCat IN ('Mobile','Phone','Mobile Phone');

-- Standardize PreferredPaymentMode
UPDATE customer_churn
SET PreferredPaymentMode = CASE
  WHEN PreferredPaymentMode = 'COD' THEN 'Cash on Delivery'
  WHEN PreferredPaymentMode = 'CC' THEN 'Credit Card'
  ELSE PreferredPaymentMode
END;

-- ---------- 5) Schema change: rename columns and add new columns ----------

-- Rename PreferedOrderCat -> PreferredOrderCat, HourSpendOnApp -> HoursSpentOnApp
ALTER TABLE customer_churn
  CHANGE COLUMN PreferedOrderCat PreferredOrderCat VARCHAR(100),
  CHANGE COLUMN HourSpendOnApp HoursSpentOnApp INT;

-- Add new columns if not exists
ALTER TABLE customer_churn
  ADD COLUMN IF NOT EXISTS ComplaintReceived ENUM('Yes','No') DEFAULT 'No',
  ADD COLUMN IF NOT EXISTS ChurnStatus ENUM('Churned','Active') DEFAULT 'Active';

-- Populate new columns based on old columns (Complain, Churn)
UPDATE customer_churn
SET ComplaintReceived = CASE WHEN IFNULL(Complain,0) = 1 THEN 'Yes' ELSE 'No' END,
    ChurnStatus = CASE WHEN IFNULL(Churn,0) = 1 THEN 'Churned' ELSE 'Active' END;

-- Drop old columns if they exist (safe in MySQL 8+)
ALTER TABLE customer_churn
  DROP COLUMN IF EXISTS Churn,
  DROP COLUMN IF EXISTS Complain;

-- Commit transformation changes
COMMIT;

-- ---------- 6) Data exploration queries (non-destructive) ----------

-- 1) Churn counts
SELECT ChurnStatus, COUNT(*) AS count_of_customers
FROM customer_churn
GROUP BY ChurnStatus;

-- 2) Avg tenure and total cashback for churned customers
SELECT ROUND(AVG(Tenure),2) AS Average_Tenure, SUM(IFNULL(CashbackAmount,0)) AS Total_CashBack
FROM customer_churn
WHERE ChurnStatus = 'Churned';

-- 3) Percentage of churned customers who complained (as percentage of churned)
SELECT
  CONCAT(ROUND(100.0 * SUM(ComplaintReceived = 'Yes') / NULLIF(COUNT(*),0), 2), '%') AS pct_churned_complained
FROM customer_churn
WHERE ChurnStatus = 'Churned';

-- 4) City tier with highest number of churned customers who prefer 'Laptop & Accessory'
SELECT CityTier, COUNT(*) AS churned_customers
FROM customer_churn
WHERE ChurnStatus = 'Churned' AND PreferredOrderCat = 'Laptop & Accessory'
GROUP BY CityTier
ORDER BY churned_customers DESC
LIMIT 1;

-- 5) Most preferred payment mode among active customers
SELECT PreferredPaymentMode, COUNT(*) AS Count_of_customers
FROM customer_churn
WHERE ChurnStatus = 'Active'
GROUP BY PreferredPaymentMode
ORDER BY Count_of_customers DESC
LIMIT 1;

-- 6) Total order amount hike for Single customers who prefer 'Mobile Phone'
SELECT MaritalStatus, PreferredOrderCat, ROUND(SUM(IFNULL(OrderAmountHikeFromlastYear,0)),2) AS Total_Order_amount_hike_lastyear
FROM customer_churn
WHERE MaritalStatus = 'Single' AND PreferredOrderCat = 'Mobile Phone'
GROUP BY MaritalStatus, PreferredOrderCat;

-- 7) Avg devices among users preferring UPI
SELECT PreferredPaymentMode, ROUND(AVG(IFNULL(NumberOfDeviceRegistered,0)),2) AS Avg_No_Of_DeviceRegistered
FROM customer_churn
WHERE PreferredPaymentMode = 'UPI'
GROUP BY PreferredPaymentMode;

-- 8) City tier with highest number of customers
SELECT CityTier, COUNT(*) AS customer_count
FROM customer_churn
GROUP BY CityTier
ORDER BY customer_count DESC
LIMIT 1;

-- 9) Gender that used the highest number of coupons (sum of coupons used)
SELECT Gender, SUM(IFNULL(CouponUsed,0)) AS total_coupons_used
FROM customer_churn
GROUP BY Gender
ORDER BY total_coupons_used DESC
LIMIT 1;

-- 10) Customers count and max hours spent on app by preferred order category
SELECT PreferredOrderCat,
       COUNT(*) AS Customer_count,
       MAX(IFNULL(HoursSpentOnApp,0)) AS Max_Hours_Spent_On_App,
       SUM(IFNULL(HoursSpentOnApp,0)) AS Total_Hours_Spent_On_App
FROM customer_churn
GROUP BY PreferredOrderCat
ORDER BY Max_Hours_Spent_On_App DESC;

-- 11) Total order count for customers who prefer Credit Card and have maximum satisfaction score
SELECT PreferredPaymentMode, SatisfactionScore, COUNT(*) AS Customer_count
FROM customer_churn
WHERE PreferredPaymentMode = 'Credit Card'
  AND SatisfactionScore = (SELECT MAX(SatisfactionScore) FROM customer_churn)
GROUP BY PreferredPaymentMode, SatisfactionScore;

-- 12) Average satisfaction score of customers who complained
SELECT ROUND(AVG(SatisfactionScore),2) AS Avg_SatisfactionScore
FROM customer_churn
WHERE ComplaintReceived = 'Yes';

-- 13) Preferred order category among customers who used more than 5 coupons
SELECT PreferredOrderCat, COUNT(*) AS Customer_Count
FROM customer_churn
WHERE IFNULL(CouponUsed,0) > 5
GROUP BY PreferredOrderCat
ORDER BY Customer_Count DESC;

-- 14) Top 3 categories by avg cashback
SELECT PreferredOrderCat, ROUND(AVG(IFNULL(CashbackAmount,0)),2) AS Avg_CashBack_Amount
FROM customer_churn
GROUP BY PreferredOrderCat
ORDER BY Avg_CashBack_Amount DESC
LIMIT 3;

-- 15) Payment modes where avg tenure is 10 months and total orders > 500
SELECT PreferredPaymentMode, ROUND(AVG(Tenure),2) AS Avg_Tenure, SUM(IFNULL(OrderCount,0)) AS Total_orders
FROM customer_churn
GROUP BY PreferredPaymentMode
HAVING ROUND(AVG(Tenure),2) = 10 AND SUM(IFNULL(OrderCount,0)) > 500;

-- 16) Warehouse distance categories and churn breakdown
SELECT
  CASE
    WHEN WarehouseToHome <= 5 THEN 'Very Close Distance'
    WHEN WarehouseToHome <= 10 THEN 'Close Distance'
    WHEN WarehouseToHome <= 15 THEN 'Moderate Distance'
    ELSE 'Far Distance'
  END AS Distance_Category,
  ChurnStatus,
  COUNT(*) AS Customer_Count
FROM customer_churn
GROUP BY Distance_Category, ChurnStatus
ORDER BY Distance_Category;

-- 17) Married customers in CityTier = 1 whose OrderCount is greater than overall average
SELECT *
FROM customer_churn
WHERE MaritalStatus = 'Married'
  AND CityTier = 1
  AND IFNULL(OrderCount,0) > (SELECT ROUND(AVG(IFNULL(OrderCount,0)),2) FROM customer_churn);

-- ---------- 7) Create customer_returns (idempotent) ----------
CREATE TABLE IF NOT EXISTS customer_returns (
  ReturnID INT PRIMARY KEY,
  CustomerID INT,
  ReturnDate DATE,
  RefundAmount DECIMAL(10,2)
);

-- Insert sample returns safely (use INSERT IGNORE to avoid duplicates if key exists)
INSERT IGNORE INTO customer_returns (ReturnID, CustomerID, ReturnDate, RefundAmount) VALUES
(1001,50022,'2023-01-01',2130),
(1002,50316,'2023-01-23',2000),
(1003,51099,'2023-02-14',2290),
(1004,52321,'2023-03-08',2510),
(1005,52928,'2023-03-20',3000),
(1006,53749,'2023-04-17',1740),
(1007,54206,'2023-04-21',3250),
(1008,54838,'2023-04-30',1990);

-- Returns + churned & complained customers details
SELECT CC.*, CR.ReturnID, CR.ReturnDate, CR.RefundAmount
FROM customer_churn CC
JOIN customer_returns CR ON CC.CustomerID = CR.CustomerID
WHERE CC.ChurnStatus = 'Churned' AND CC.ComplaintReceived = 'Yes';
